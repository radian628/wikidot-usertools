"use strict";(()=>{function T(t){let e=document.querySelector(t);return e?Promise.resolve(e):new Promise((o,r)=>{let n=new MutationObserver(()=>{let i=document.querySelector(t);i&&(n.disconnect(),o(i))});n.observe(document.body,{childList:!0,subtree:!0})})}function x(t){return document.querySelector(t)?new Promise((o,r)=>{let n=new MutationObserver(()=>{document.querySelector(t)||(n.disconnect(),o())});n.observe(document.body,{childList:!0,subtree:!0})}):Promise.resolve()}function w(t,e){let o=[],r=e.limits.reduce((l,m)=>Math.max(l,m.duration),0),n=[],i=new Set;setInterval(()=>{for(;;){let l=o.at(0);if(!l)return;let m=Date.now();if(n=n.filter(c=>(m-c.time)/1e3<=r),i.size>=e.maxConcurrentRequests)return;for(let c of e.limits){let p=0;for(let h of n)(m-h.time)/1e3<=c.duration&&p++;if(p>=c.maxRequests)return}o.shift(),n.push({time:Date.now()});let f=t(...l.params);i.add(f),(async()=>{let c=await f;l.callback(c),i.delete(f)})()}});let s=(...l)=>new Promise((m,f)=>{o.push({params:l,callback:c=>{m(c)}})});return s._throttled=!0,s}function P(t){return new Promise((e,o)=>{let r=t(n=>{r(),e(n)})})}function S(t,e){t="radian628-wikidot-usertools-"+t;let o=new Set,r={get(){let n=localStorage.getItem(t);if(!n)return e;try{return JSON.parse(n)}catch{return e}},set(n){localStorage.setItem(t,JSON.stringify(n));for(let i of o)i(n)},subscribe(n){return o.add(n),()=>{o.delete(n)}}};return!r.get()&&e&&r.set(e),r}function E(t){let e=document.createElement("input");e.value=t.get();let o=t.subscribe(r=>{e.value!==r&&(e.value=r)});return e.oninput=()=>{t.set(e.value)},{element:e,unmount:o}}var C=S("filter-by-wiki","");function k(){let t=E(C),e=document.createElement("div");e.appendChild(t.element);let o=document.createElement("p");return o.innerText="Put the wiki slug in the text box above (without quotes) to view posts from only that wiki (e.g. 'scp-wiki', 'scp-sandbox-3', 'scp-wiki-cn', etc.). Leave empty to perform no filtering.",e.appendChild(o),{element:e,wikiFilter:C,unmount:()=>{t.unmount()}}}function q(t){let e=document.createElement("div");e.style.height=t,e.style.marginTop=`-${t}`,e.style.pointerEvents="none";let o=new Set,r=new IntersectionObserver(s=>{console.log("intersectionobserver callback",s);for(let l of s)if(l.isIntersecting){n=!0;for(let m of o)m();return}n=!1},{root:null,threshold:.01});r.observe(e);let n;function i(){if(console.log("isVisible",n),n===void 0){for(let s of r.takeRecords())if(s.isIntersecting)return n=!0;return n=!1}else return n}return{element:e,onVisible(s){return o.add(s),setTimeout(()=>{i()&&o.has(s)&&(console.log("initially visible"),s())}),()=>{o.delete(s)}},isVisible:i}}function R(t,e){return new Promise((o,r)=>{OZONE.ajax.requestModule("userinfo/UserRecentPostsListModule",{page:e,userId:t},n=>{o(n)})})}async function M(t,e,o){let r=await o(t,e);return U(r.body??"",".thread-container")}function U(t,e){let o=document.createElement("div");return o.innerHTML=t,o.querySelector(e)}async function L(t,e){let o=async i=>{let s=await e(i);return!s||s.children.length===0},r=1;for(;!await o(r);)r*=2;let n=Math.floor(r/2);for(;Math.abs(r-n)>1;){let i=Math.floor((n+r)/2);await o(i)?r=i:n=i}return Math.max(0,n-1)*20+((await e(n))?.children.length??0)}window.getUserCommentPageElements=M;function F(t,e,o){let r=new Map,n=1,i=!1;async function s(u,d){let b=n++,a=await l(u,b,d);return(!a||a?.children.length==0)&&(i=!0),a}async function l(u,d,b){return r.has(d)?r.get(d):M(u,d,b).then(a=>(r.set(d,a),a))}let m=o.subscribe(u=>{console.log("test",u,o.get()),f()});function f(){let u=o.get().trim(),d=document.querySelectorAll(".forum-recent-posts-box .post"),b=!1;for(let a of Array.from(d)){let v=a.querySelector(".info > a:nth-last-child(1)");if(v)u.length===0||v.href.includes(`://${u}.wikidot.com`)?(a.style.display="block",b=!0):a.style.display="none";else{let y=document.createElement("p");y.innerText="Warning: Unable to identify the wiki this post originated from.",y.style="color: red;",y.className="delete-after-post-visibility-updates",a.appendChild(y),b=!0}}}let c=q("100vh"),p=document.createElement("div"),h=!1;t.appendChild(c.element),t.appendChild(p);let g="???",I=(async()=>{g=(await L(e,d=>l(e,d,w(R,{maxConcurrentRequests:5,limits:[{duration:2,maxRequests:6}]})))).toString()})();return(async()=>{for(;!h&&!i;){await P(c.onVisible),p.innerText=`Loading more comments... (${document.querySelectorAll(".forum-recent-posts-box .post").length} / ${g})`;let u=await s(e,w(R,{maxConcurrentRequests:3,limits:[{duration:1/3,maxRequests:1}]}));u&&(t.insertBefore(u,c.element),f())}await I,p.innerText=`All comments for this user have been loaded. (${g} / ${g})`})(),()=>{h=!0,m()}}(async()=>{for(;;){let t=await T(".forum-recent-posts-box:has(#forum-recent-posts-list)"),e=t.querySelector("#recent-posts-user-id")?.value??"";for(let i of Array.from(t.children))i.parentElement?.removeChild(i);let o=document.createElement("div");o.id="better-comments-view-indicator",t.appendChild(o);let r=k();t.parentElement&&t.parentElement.insertBefore(r.element,t);let n=F(t,e,r.wikiFilter);await x("#better-comments-view-indicator"),n(),r.unmount()}})();})();
/*!
// ==UserScript==
// @name        UserInfo Better Comments View 
// @match       *://*.wikidot.com/user:info/*
// @grant       none
// @version     1.0
// @author      radian628
// @description A nicer way to view Wikidot comments. 
// ==/UserScript==
*/
