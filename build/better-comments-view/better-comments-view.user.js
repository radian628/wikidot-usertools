"use strict";(()=>{function T(t){let e=document.querySelector(t);return e?Promise.resolve(e):new Promise((r,o)=>{let n=new MutationObserver(()=>{let i=document.querySelector(t);i&&(n.disconnect(),r(i))});n.observe(document.body,{childList:!0,subtree:!0})})}function x(t){return document.querySelector(t)?new Promise((r,o)=>{let n=new MutationObserver(()=>{document.querySelector(t)||(n.disconnect(),r())});n.observe(document.body,{childList:!0,subtree:!0})}):Promise.resolve()}function y(t,e){let r=[],o=e.limits.reduce((l,m)=>Math.max(l,m.duration),0),n=[],i=new Set;setInterval(()=>{for(;;){let l=r.at(0);if(!l)return;let m=Date.now();if(n=n.filter(c=>(m-c.time)/1e3<=o),i.size>=e.maxConcurrentRequests)return;for(let c of e.limits){let p=0;for(let h of n)(m-h.time)/1e3<=c.duration&&p++;if(p>=c.maxRequests)return}r.shift(),n.push({time:Date.now()});let f=t(...l.params);i.add(f),(async()=>{let c=await f;l.callback(c),i.delete(f)})()}});let s=(...l)=>new Promise((m,f)=>{r.push({params:l,callback:c=>{m(c)}})});return s._throttled=!0,s}function P(t){return new Promise((e,r)=>{let o=t(n=>{o(),e(n)})})}function S(t,e){t="radian628-wikidot-usertools-"+t;let r=new Set,o={get(){let n=localStorage.getItem(t);if(!n)return e;try{return JSON.parse(n)}catch{return e}},set(n){localStorage.setItem(t,JSON.stringify(n));for(let i of r)i(n)},subscribe(n){return r.add(n),()=>{r.delete(n)}}};return!o.get()&&e&&o.set(e),o}function E(t){let e=document.createElement("input");e.value=t.get();let r=t.subscribe(o=>{e.value!==o&&(e.value=o)});return e.oninput=()=>{t.set(e.value)},{element:e,unmount:r}}var C=S("filter-by-wiki","");function k(){let t=E(C),e=document.createElement("div");e.appendChild(t.element);let r=document.createElement("p");return r.innerText="Put the wiki slug in the text box above (without quotes) to view posts from only that wiki (e.g. 'scp-wiki', 'scp-sandbox-3', 'scp-wiki-cn', etc.). Leave empty to perform no filtering.",e.appendChild(r),{element:e,wikiFilter:C,unmount:()=>{t.unmount()}}}function q(t){let e=document.createElement("div");e.style.height=t,e.style.marginTop=`-${t}`,e.style.pointerEvents="none";let r=new Set,o=new IntersectionObserver(s=>{console.log("intersectionobserver callback",s);for(let l of s)if(l.isIntersecting){n=!0;for(let m of r)m();return}n=!1},{root:null,threshold:.01});o.observe(e);let n;function i(){if(console.log("isVisible",n),n===void 0){for(let s of o.takeRecords())if(s.isIntersecting)return n=!0;return n=!1}else return n}return{element:e,onVisible(s){return r.add(s),setTimeout(()=>{i()&&r.has(s)&&(console.log("initially visible"),s())}),()=>{r.delete(s)}},isVisible:i}}function R(t,e){return new Promise((r,o)=>{OZONE.ajax.requestModule("userinfo/UserRecentPostsListModule",{page:e,userId:t},n=>{r(n)})})}async function M(t,e,r){let o=await r(t,e);return U(o.body??"",".thread-container")}function U(t,e){let r=document.createElement("div");return r.innerHTML=t,r.querySelector(e)}async function L(t,e){let r=async i=>{let s=await e(i);return!s||s.children.length===0},o=1;for(;!await r(o);)o*=2;let n=Math.floor(o/2);for(;Math.abs(o-n)>1;){let i=Math.floor((n+o)/2);await r(i)?o=i:n=i}return Math.max(0,n-1)*20+((await e(n))?.children.length??0)}window.getUserCommentPageElements=M;function F(t,e,r){let o=new Map,n=1,i=!1;async function s(u,d){let b=n++,a=await l(u,b,d);return(!a||a?.children.length==0)&&(i=!0),a}async function l(u,d,b){return o.has(d)?o.get(d):M(u,d,b).then(a=>(o.set(d,a),a))}let m=r.subscribe(u=>{console.log("test",u,r.get()),f()});function f(){let u=r.get().trim(),d=document.querySelectorAll(".forum-recent-posts-box .post"),b=!1;for(let a of Array.from(d)){let v=a.querySelector(".info > a:nth-last-child(1)");if(v)u.length===0||v.href.includes(`://${u}.wikidot.com`)?(a.style.display="block",b=!0):a.style.display="none";else{let w=document.createElement("p");w.innerText="Warning: Unable to identify the wiki this post originated from.",w.style="color: red;",w.className="delete-after-post-visibility-updates",a.appendChild(w),b=!0}}}let c=q("100vh"),p=document.createElement("div"),h=!1;t.appendChild(c.element),t.appendChild(p);let g="???",I=(async()=>{g=(await L(e,d=>l(e,d,y(R,{maxConcurrentRequests:5,limits:[{duration:2,maxRequests:6}]})))).toString()})();return(async()=>{for(;!h&&!i;){await P(c.onVisible),p.innerText=`Loading more comments... (${document.querySelectorAll(".forum-recent-posts-box .post").length} / ${g})`;let u=await s(e,y(R,{maxConcurrentRequests:3,limits:[{duration:1/3,maxRequests:1}]}));u&&(t.insertBefore(u,c.element),f())}await I,p.innerText=`All comments for this user have been loaded. (${g} / ${g})`})(),()=>{h=!0,m()}}(async()=>{for(;;){let t=await T(".forum-recent-posts-box:has(#forum-recent-posts-list)"),e=t.querySelector("#recent-posts-user-id")?.value??"";for(let i of Array.from(t.children))i.parentElement?.removeChild(i);let r=document.createElement("div");r.id="better-comments-view-indicator",t.appendChild(r);let o=k();t.parentElement&&t.parentElement.insertBefore(o.element,t);let n=F(t,e,o.wikiFilter);await x("#better-comments-view-indicator"),n(),o.unmount()}})();})();
/*!
// ==UserScript==
// @name        UserInfo Better Comments View 
// @match       *://*.wikidot.com/user:info/*
// @grant       none
// @version     1.0
// @author      radian628
// @description A nicer way to view Wikidot comments. 
// ==/UserScript==
*/
//# sourceMappingURL=better-comments-view.user.js.map
